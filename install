#!/bin/bash -e

# Check dependencies
printf "\n---- Checking dependencies ----\n"
for dep in slock rsync feh xbacklight xsetroot firefox nnn mupdf vim make \
pkg-config gcc; do
	command -v $dep || (echo "need $dep"; exit 1)
done

# Install base code.
printf "\n---- Installing codebase ----\n"
mkdir -p ~/.config
rsync -av --delete --exclude cache filetlignux/ ~/.config/filetlignux

# Build everything that needs to be compiled.
for build in filetwm filetwmconf filetmenu st filetstatus fonts mimi; do
	printf "\n---- Building ${build} ----\n"
	cd ~/.config/filetlignux/$build/; make; cd -
done

# Install fonts.
printf "\n---- Installing fonts ----\n"
mkdir -p ~/.local/share/fonts
find ~/.config/filetlignux/fonts/cache/*/fonts -type f | \
	awk '{printf("ln -f -s %s ~/.local/share/fonts/\n", $1)}' | sh

# Installing home dir config files.
printf "\n---- Linking HOME dir config files ----\n"
for file in $(find ~/.config/filetlignux/installs/ -type f -o -type l); do
	dest=$(echo $file | sed -e 's:^.*/filetlignux/installs/::')
	printf "$dest\n"
	if [[ -L ~/$dest && `readlink ~/$dest` \
	== `ls -1a ~/.config/filetlignux/installs/$dest` ]]; then
		printf "...ok\n"
	else
		if [ -f ~/$dest ]; then
			echo "...moving aside (~/$dest.old)"
			mv ~/$dest ~/$dest.old
		fi
		echo "...installing link (~/$dest)"
		mkdir -p $(dirname ~/$dest)
		ln -s $file ~/$dest
	fi
done

# Prep
mkdir -p ~/.vim
