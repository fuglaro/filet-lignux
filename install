#!/bin/bash -e


printf "\n---- Checking dependencies ----\n"
# Hard dependencies
#  - slock,xbacklight,feh,alacritty,xsetroot: for filetwm (and default app)
DEPS="slock feh xbacklight alacritty xsetroot make gcc busybox rsync wget"
# Preferred applications
PRFS="mupdf vlc nvim tmux nnn"
for dep in $DEPS; do command -v $dep >/dev/null || echo "need: $dep"; done
for dep in $PRFS; do command -v $dep >/dev/null || echo "suggested: $dep"; done
for dep in $DEPS; do command -v $dep >/dev/null || exit 1; done
for dep in $PRFS; do command -v $dep >/dev/null || \
(read -p "Ignore (y)?"; test "$REPLY" == 'y' || exit 1;) done


printf "\n---- Updating dependencies ----\n"
git submodule update --init --depth=1


printf "\n---- Installing codebase ----\n"
mkdir -p ~/.config
rsync -av --delete --exclude filetlignux/ ~/.config/filetlignux


# Build all the things that need compiling or constructing.
# Note that these won't get automatic updates:
for build in filet-wm; do
	printf "\n---- Building $build ----\n"
	cd ~/.config/filetlignux/$build/; make all; cd -
done


printf "\n---- Linking HOME dir config files ----\n"
while IFS= read -r file; do
	dest=$(echo "$file" | sed -e 's:^.*/filetlignux/installs/::')
	printf "$dest\n"
	if [[ -L ~/"$dest" && `readlink ~/"$dest"` \
	== `ls -1da ~/.config/filetlignux/installs/"$dest"` ]]; then
		printf "...ok\n"
	else
		if [ -f ~/"$dest" ]; then
			echo "...moving aside (~/$dest.old)"
			mv ~/"$dest" ~/"$dest.old"
		fi
		echo "...installing link (~/$dest)"
		mkdir -p $(dirname ~/"$dest")
		ln -s "$file" ~/"$dest"
	fi
done <<< $(find ~/.config/filetlignux/installs/ -type f -o -type l)


printf "\n---- Done ----\n"
