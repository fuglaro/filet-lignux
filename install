#!/bin/bash -e

# Check dependencies
printf "\n---- Checking dependencies ----\n"
# Hard dependencies
DEPS="slock feh xbacklight alacritty xsetroot make gcc unzip rsync"
# Preferred applications
PRFS="feh mupdf vlc vim tmux"
for dep in $DEPS; do command -v $dep >/dev/null || echo "need: $dep"; done
for dep in $PRFS; do command -v $dep >/dev/null || echo "suggested: $dep"; done
for dep in $DEPS; do command -v $dep >/dev/null || exit 1; done
for dep in $PRFS; do command -v $dep >/dev/null || \
(read -p "Ignore (y)?"; test "$REPLY" == 'y' || exit 1;) done

# Install base code.
printf "\n---- Installing codebase ----\n"
mkdir -p ~/.config
rsync -av --delete --exclude cache filetlignux/ ~/.config/filetlignux

# Build all the things that need compiling or constructing.
for build in filetwm mimi; do
	printf "\n---- Building $build ----\n"
	cd ~/.config/filetlignux/$build/; make; cd -
done

# Install fonts.
printf "\n---- Setup fonts ----\n"
mkdir -p ~/.config/filetlignux/installs/.local/share/fonts
wget -qO- 'https://github.com/ryanoasis/nerd-fonts/releases/latest/download/CascadiaCode.zip' | busybox unzip -d ~/.config/filetlignux/installs/.local/share/fonts -

# Installing home dir config files.
printf "\n---- Linking HOME dir config files ----\n"
while IFS= read -r file; do
	dest=$(echo "$file" | sed -e 's:^.*/filetlignux/installs/::')
	printf "$dest\n"
	if [[ -L ~/"$dest" && `readlink ~/"$dest"` \
	== `ls -1a ~/.config/filetlignux/installs/"$dest"` ]]; then
		printf "...ok\n"
	else
		if [ -f ~/"$dest" ]; then
			echo "...moving aside (~/$dest.old)"
			mv ~/"$dest" ~/"$dest.old"
		fi
		echo "...installing link (~/$dest)"
		mkdir -p $(dirname ~/"$dest")
		ln -s "$file" ~/"$dest"
	fi
done <<< $(find ~/.config/filetlignux/installs/ -type f -o -type l)

# Prep
mkdir -p ~/.vim
